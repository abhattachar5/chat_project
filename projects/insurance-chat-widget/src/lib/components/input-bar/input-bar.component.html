<div class="ins-input-bar-container">
  <!-- Hint Row -->
  @if (showHint() && question?.helpText) {
    <div class="ins-input-hint" [attr.aria-describedby]="'hint-' + question?.id">
      <mat-icon class="ins-hint-icon">info</mat-icon>
      <span [id]="'hint-' + (question?.id || 'unknown')">{{ question?.helpText }}</span>
    </div>
  }

  <!-- Partial Transcript Display -->
  @if (partialTranscript() && isVoiceMode()) {
    <div class="ins-partial-transcript" [attr.aria-live]="'polite'">
      <mat-icon class="ins-partial-icon">auto_awesome</mat-icon>
      <span class="ins-partial-text">{{ partialTranscript() }}</span>
    </div>
  }

  <!-- Input Form -->
  <form [formGroup]="inputForm" (ngSubmit)="onSubmit()" class="ins-input-form">
    <mat-form-field appearance="outline" class="ins-input-field">
      <input
        matInput
        formControlName="answer"
        [type]="getInputType()"
        [placeholder]="question?.prompt || 'Type your answer...'"
        [attr.aria-label]="question?.prompt || 'Enter your answer'"
        [attr.aria-describedby]="question?.helpText ? 'hint-' + question?.id : null"
        (keydown.enter)="onEnterKey($any($event))"
        (keydown.escape)="onEscapeKey($any($event))" />
      
      @if (inputForm.get('answer')?.invalid && inputForm.get('answer')?.touched) {
        <mat-error>
          {{ getErrorMessage() }}
        </mat-error>
      }
      
      @if (error && !inputForm.get('answer')?.errors) {
        <mat-error>
          {{ error }}
        </mat-error>
      }

      @if (showMicButton() && !isVoiceMode()) {
        <button
          matSuffix
          mat-icon-button
          type="button"
          (click)="micStart.emit()"
          aria-label="Start voice input"
          title="Start voice input (Alt+V)"
          class="ins-mic-toggle">
          <mat-icon aria-hidden="true">mic</mat-icon>
        </button>
      }

      @if (!isVoiceMode()) {
        <button
          matSuffix
          mat-button
          type="submit"
          [disabled]="!isFormValid()"
          aria-label="Submit answer"
          title="Submit answer (Enter)"
          class="ins-submit-button">
          <mat-icon>send</mat-icon>
          <span class="ins-submit-text">Send</span>
        </button>
      }
    </mat-form-field>

    @if (isLoading) {
      <div class="ins-loading-indicator">
        <span>Sending...</span>
      </div>
    }
  </form>

  <!-- Format Example -->
  @if (question?.constraints?.mask && !isVoiceMode()) {
    <div class="ins-format-example">
      <span class="ins-format-label">Example:</span>
      <span class="ins-format-value">{{ getFormatExample() }}</span>
    </div>
  }
  
  <!-- Voice Mode Controls -->
  @if (isVoiceMode()) {
    <div class="ins-voice-controls">
      <ins-mic-button
        [disabled]="isLoading"
        [silenceTimeout]="5000"
        (captureStart)="micStart.emit()"
        (captureStop)="onVoiceStop()"
        (captureCancel)="onVoiceCancel()"
        (error)="errorMessage.set($event)" />
      
      <ins-vu-meter
        [width]="200"
        [height]="40"
        [showNumeric]="false" />
    </div>
  }
</div>

